#!/bin/bash

echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ–º..."

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd /opt/clicker 2>/dev/null || cd .

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
echo "‚èπÔ∏è –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker-compose down --remove-orphans

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ—Ä—Ç 80 —Å–≤–æ–±–æ–¥–µ–Ω
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–Ω—è—Ç—ã–µ –ø–æ—Ä—Ç—ã..."
if netstat -tlnp | grep :80 > /dev/null; then
    echo "‚ö†Ô∏è –ü–æ—Ä—Ç 80 –∑–∞–Ω—è—Ç. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –µ–≥–æ –∑–∞–Ω–∏–º–∞–µ—Ç:"
    netstat -tlnp | grep :80
    
    # –ü—ã—Ç–∞–µ–º—Å—è –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å nginx –µ—Å–ª–∏ –æ–Ω –∑–∞–ø—É—â–µ–Ω
    if systemctl is-active --quiet nginx; then
        echo "üîÑ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π nginx..."
        systemctl stop nginx
        systemctl disable nginx
    fi
    
    # –ü—ã—Ç–∞–µ–º—Å—è –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å apache –µ—Å–ª–∏ –æ–Ω –∑–∞–ø—É—â–µ–Ω
    if systemctl is-active --quiet apache2; then
        echo "üîÑ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º apache2..."
        systemctl stop apache2
        systemctl disable apache2
    fi
fi

# –û—á–∏—â–∞–µ–º Docker
echo "üßπ –û—á–∏—â–∞–µ–º Docker..."
docker system prune -f
docker volume prune -f

# –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑—ã
echo "üî® –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑—ã..."
docker-compose build --no-cache

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å –Ω–æ–≤—ã–º–∏ –ø–æ—Ä—Ç–∞–º–∏
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–∞ –ø–æ—Ä—Ç–∞—Ö 8080/8443..."
docker-compose up -d

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ (30 —Å–µ–∫)..."
sleep 30

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
docker-compose ps

echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º API
if curl -f http://localhost:8080/api/counter &>/dev/null; then
    echo "‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 8080"
else
    echo "‚ùå API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
    echo "üìã –õ–æ–≥–∏ –±—ç–∫–µ–Ω–¥–∞:"
    docker-compose logs --tail=10 backend
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
if curl -f http://localhost:8080/ &>/dev/null; then
    echo "‚úÖ –§—Ä–æ–Ω—Ç–µ–Ω–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 8080"
else
    echo "‚ùå –§—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
    echo "üìã –õ–æ–≥–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞:"
    docker-compose logs --tail=10 frontend
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
if curl -f http://localhost:8080/api/documents &>/dev/null; then
    echo "‚úÖ API –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    echo "‚ùå API –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
fi

echo ""
echo "üéâ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo "üìç –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É:"
echo "üåê http://77.222.42.53:8080"
echo ""
echo "üîß –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã –æ—Å—Ç–∞–ª–∏—Å—å:"
echo "docker-compose logs -f  # –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏"
echo "docker-compose restart  # –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å"
echo "docker-compose down && docker-compose up -d  # –ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫"